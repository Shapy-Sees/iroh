flowchart TD
    Input[Phone Input] --> InputType{Input Type?}
    
    InputType -->|DTMF| DTMFDetect[DTMF Detector]
    InputType -->|Voice| VoiceDetect[Voice Detector]
    
    DTMFDetect --> ValidateDTMF{Valid DTMF?}
    ValidateDTMF -->|No| ErrorTone[Play Error Tone]
    ValidateDTMF -->|Yes| ParseDTMF[Parse DTMF Command]
    
    VoiceDetect --> STT[Speech to Text]
    STT --> Intent[Intent Detection]
    
    ParseDTMF --> CommandRouter[Command Router]
    Intent --> CommandRouter
    
    CommandRouter --> ValidateCmd{Validate Command}
    ValidateCmd -->|Invalid| HandleError[Error Handler]
    ValidateCmd -->|Valid| CmdType{Command Type}
    
    CmdType -->|Home| HomeAssistant[Home Assistant API]
    CmdType -->|Music| Music[Music Service]
    CmdType -->|System| System[System Control]
    CmdType -->|Info| Info[Information Service]
    
    HomeAssistant --> StateUpdate[Update State]
    Music --> StateUpdate
    System --> StateUpdate
    Info --> StateUpdate
    
    StateUpdate --> GenerateResponse[Generate Response]
    HandleError --> GenerateResponse
    
    GenerateResponse --> TTS[Text to Speech]
    TTS --> PlayAudio[Play Audio Response]
    
    ErrorTone --> EndFlow[End]
    PlayAudio --> EndFlow
    
    subgraph Legend
        direction LR
        Start[Start/End] --- Process[Process] --- Decision{Decision}
    end
    
    %% Styling
    classDef process fill:#e1f5fe,stroke:#01579b
    classDef decision fill:#fff3e0,stroke:#e65100
    classDef start fill:#c8e6c9,stroke:#1b5e20
    classDef error fill:#ffcdd2,stroke:#b71c1c
    
    class Input,PlayAudio,EndFlow start
    class DTMFDetect,VoiceDetect,ParseDTMF,STT,Intent,CommandRouter,StateUpdate,GenerateResponse,TTS process
    class InputType,ValidateDTMF,ValidateCmd,CmdType decision
    class ErrorTone,HandleError error